defaultTasks 'info'

ext {
	PHP_TAG = getTheTag()
	PHP_CONTAINER_NAME = "pedido-api"
	PHP_IMAGE_NAME_DEV = "${PHP_CONTAINER_NAME}-dev:$PHP_TAG"
	PHP_WWW = "/var/www/html"

	MYSQL_CONTAINER_NAME = "pedido-mysql"
	MYSQL_IMAGE_NAME = "${MYSQL_CONTAINER_NAME}:$PHP_TAG"

}

task 'info' << {
	println """
	tag      : ${project.PHP_TAG}
	container: ${project.PHP_CONTAINER_NAME}
	image    : ${project.PHP_IMAGE_NAME_DEV}
	project  : ${project.PHP_WWW}
	"""
}

/**
 * roda o sistema em modo dev
 * este método já chama o build e up necessário
 */
task 'build-dev' (type:Exec) {
}

/**
 * roda o sistema em modo test (com a base de dados do src)
 * este método já chama o build e up necessário
 */
task 'build-test' << {

}

/**
 * roda o php em modo dev
 * este método já chama o build e up necessário
 */
task 'build-php-dev' (type:Exec) {
	commandLine = ['docker', 'build', '--rm', '--tag', "${PHP_IMAGE_NAME_DEV}", '-f', 'docker/php/Dockerfile', '.']
}

/**
 * roda o mysql
 * este método já chama o build e up necessário
 */
task 'build-mysql' (type:Exec) {
	workingDir = 'docker/mysql'
	commandLine = ['docker', 'build', '--rm', '--tag', "${MYSQL_IMAGE_NAME}", '.']
}


/**
 * roda o sistema php
 */
task 'docker-php-up' << {

}

/**
 * roda o banco de dados consumindo os 
 * dados que estão salvos no projeto
 */
task 'docker-mysql-up' (type:Exec) {
	removeImage(MYSQL_IMAGE_NAME)
	commandLine = ['docker', 'run', '--expose', '3306',
		'--hostname', MYSQL_CONTAINER_NAME,
		'--name', MYSQL_CONTAINER_NAME,
		'--detach',
		'--env',
				'"MYSQL_ROOT_PASSWORD=root"',
		MYSQL_IMAGE_NAME
	]
}

/**
 * roda o banco de dados consumindo os 
 * dados da maquina do desenvolvedor
 */
task 'docker-mysql-up-dev' << {
	
}

/**
 * apaga todas as imagens e containers
 * gerados por este projeto
 */
task 'docker-clear' << {

}

def removeLast(String str) {
	str.substring(0, str.length()-1);
}
def getTheTag(){
	removeLast(['git', 'describe', '--abbrev=0', '--tags'].execute().text)
}
def removeImage(String image){
	['docker', 'rm', '-f', image].execute()
}